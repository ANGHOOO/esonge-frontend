# Week 13-17: 장바구니 및 주문 시스템 (로컬)

**기간**: Week 13-17
**목표**: 장바구니, 주문 생성, 결제 스텁, 배송비 계산 구현 (외부 PG 연동 없음)
**프론트엔드 연동**: Week 13부터 시작

---

## 📋 Issue Tickets

### [BE-034] CartItem Entity 및 장바구니 시스템 구현

**Priority**: 🔴 Critical
**Estimated Time**: 10 hours

#### Description

사용자의 장바구니 아이템을 관리하는 시스템을 구현합니다. 로그인한 사용자는 user_id로, 게스트 사용자는 session_id로 장바구니를 관리합니다.

#### Functional Requirements

**Entity 설계:**

- CartItem 테이블 생성
  - id (Primary Key, Auto Increment)
  - user_id (FK to users, nullable - 로그인 사용자용)
  - session_id (String, nullable - 게스트용, UUID 형태)
  - product_id (FK to products, not null)
  - quantity (Integer, not null, default 1, min 1)
  - options (JSONB, nullable - 상품 옵션 저장: 등급, 중량 등)
  - created_at, updated_at
  - Unique constraint: (user_id, product_id, options) OR (session_id, product_id, options)

**비즈니스 로직:**

1. **장바구니 조회**
   - 로그인 사용자: user_id로 조회
   - 게스트: session_id로 조회 (쿠키 또는 로컬스토리지의 세션 ID 사용)
   - 상품 정보(이름, 가격, 이미지, 재고) JOIN하여 반환
   - 품절된 상품 표시 (재고 0인 경우)

2. **장바구니에 상품 추가**
   - 동일 상품+옵션이 이미 있으면 수량 증가
   - 없으면 새로운 CartItem 생성
   - 재고 검증: 요청 수량이 재고보다 많으면 에러
   - 최대 수량 제한: 1개 상품당 최대 99개

3. **장바구니 수량 수정**
   - 수량을 0으로 설정하면 삭제로 처리
   - 재고 검증 수행
   - 수량 범위: 1~99

4. **장바구니 아이템 삭제**
   - 특정 아이템 삭제
   - 전체 장바구니 비우기 기능

5. **게스트 장바구니 병합 (로그인 시)**
   - 로그인 전 session_id로 저장된 장바구니
   - 로그인 후 user_id 장바구니와 병합
   - 동일 상품이 있으면 수량 합산 (재고 초과 시 재고 수량으로 제한)
   - 병합 후 session_id 장바구니는 삭제

6. **재고 검증**
   - 장바구니 조회 시 각 아이템의 현재 재고 확인
   - 재고 부족한 아이템 별도 표시
   - 주문 진행 전 전체 재고 재검증

**API Endpoints:**

- `GET /api/cart` - 장바구니 조회
  - Query param: sessionId (게스트용)
  - Response: 장바구니 아이템 목록 + 총 금액

- `POST /api/cart` - 장바구니에 추가
  - Request body: productId, quantity, options, sessionId (optional)
  - Response: 추가된 아이템 정보

- `PUT /api/cart/{cartItemId}` - 수량 수정
  - Request body: quantity
  - Response: 수정된 아이템 정보

- `DELETE /api/cart/{cartItemId}` - 아이템 삭제
  - Response: 성공 메시지

- `DELETE /api/cart` - 전체 삭제
  - Query param: sessionId (게스트용)
  - Response: 성공 메시지

- `POST /api/cart/merge` - 게스트 장바구니 병합 (로그인 시 자동 호출)
  - Request body: sessionId
  - Response: 병합 결과

**Error Handling:**

- 재고 부족: `INSUFFICIENT_STOCK`
- 상품 없음: `PRODUCT_NOT_FOUND`
- 최대 수량 초과: `MAX_QUANTITY_EXCEEDED`
- 장바구니 아이템 없음: `CART_ITEM_NOT_FOUND`

#### Acceptance Criteria

- 로그인/게스트 모두 장바구니 사용 가능
- 재고 검증이 모든 단계에서 수행됨
- 게스트 장바구니가 로그인 시 정상 병합됨
- 동일 상품+옵션 중복 방지

---

### [BE-035] Order 및 OrderItem Entity 구현

**Priority**: 🔴 Critical
**Estimated Time**: 12 hours

#### Description

주문 정보를 저장하고 관리하는 시스템을 구현합니다. 결제는 로컬 스텁으로 처리하며, 실제 PG 연동은 Week 22-25에 진행합니다.

#### Functional Requirements

**Entity 설계:**

1. **Orders 테이블**
   - id (PK, Auto Increment)
   - order_number (String, Unique, 자동 생성: "ORD-YYYYMMDD-6자리난수")
   - user_id (FK to users, not null)
   - order_status (Enum: PENDING_PAYMENT, PAYMENT_COMPLETED, PREPARING, SHIPPED, DELIVERED, CANCELLED, REFUNDED)
   - payment_status (Enum: PENDING, COMPLETED, FAILED, REFUNDED)
   - payment_method (Enum: BANK_TRANSFER, CREDIT_CARD, KAKAO_PAY, NAVER_PAY, DEPOSIT, MILEAGE)
   -
   - **배송 정보**
     - recipient_name (String, not null)
     - recipient_phone (String, not null)
     - postal_code (String, not null)
     - address (String, not null)
     - detail_address (String)
     - delivery_memo (String, 배송 메모)

   - **금액 정보**
     - subtotal_amount (상품 금액 합계)
     - shipping_fee (배송비)
     - discount_amount (할인 금액)
     - coupon_discount (쿠폰 할인)
     - mileage_used (적립금 사용)
     - deposit_used (예치금 사용)
     - total_amount (최종 결제 금액)

   - **기타**
     - coupon_code (사용한 쿠폰 코드)
     - order_memo (주문 메모)
     - created_at, updated_at
     - cancelled_at (취소 시간)
     - cancel_reason (취소 사유)

2. **OrderItems 테이블**
   - id (PK, Auto Increment)
   - order_id (FK to orders, not null)
   - product_id (FK to products, not null)
   - product_name (주문 시점의 상품명, 스냅샷)
   - product_price (주문 시점의 가격, 스냅샷)
   - quantity (Integer, not null)
   - options (JSONB, 옵션 정보)
   - item_total_price (상품가격 × 수량)

3. **OrderStatusHistory 테이블** (주문 상태 변경 이력)
   - id (PK, Auto Increment)
   - order_id (FK to orders, not null)
   - status (order_status와 동일한 Enum)
   - changed_by (관리자 ID, nullable)
   - memo (변경 사유/메모)
   - created_at

**비즈니스 로직:**

1. **주문 생성 프로세스**

   **Step 1: 주문 정보 검증**
   - 장바구니 아이템 존재 확인
   - 모든 상품의 재고 검증
   - 배송지 정보 필수 입력 확인

   **Step 2: 금액 계산**
   - 상품 금액 합계 계산
   - 배송비 계산 (배송비 정책 적용)
   - 쿠폰 할인 계산 (있는 경우)
   - 적립금 사용 검증 및 차감
   - 예치금 사용 검증 및 차감
   - 최종 결제 금액 = 상품금액 + 배송비 - 쿠폰할인 - 적립금 - 예치금

   **Step 3: 주문 생성**
   - 주문번호 자동 생성
   - Orders 레코드 생성 (상태: PENDING_PAYMENT)
   - OrderItems 레코드 생성 (장바구니 → 주문 아이템 복사)
   - 상품 정보 스냅샷 저장 (가격, 상품명 등)

   **Step 4: 재고 차감**
   - 각 상품의 stock_quantity 차감
   - 재고가 0이 되면 품절 처리

   **Step 5: 혜택 처리**
   - 쿠폰 사용 처리 (UserCoupon.isUsed = true)
   - 적립금 차감 (MileageTransaction 생성)
   - 예치금 차감 (DepositTransaction 생성)

   **Step 6: 장바구니 비우기**
   - 주문 완료된 아이템들 장바구니에서 삭제

   **Step 7: 결제 대기 상태 반환**
   - 주문 ID 및 결제 정보 반환

2. **결제 처리 (로컬 스텁)**
   - 실제 PG 연동 없이 결제 완료로 시뮬레이션
   - payment_status를 COMPLETED로 변경
   - order_status를 PAYMENT_COMPLETED로 변경
   - 적립금 적립 (상품 금액의 1~3%, 회원 등급별)
   - OrderStatusHistory에 기록
   - 주문 확인 이메일 발송 예약 (실제 발송은 Week 22-25)

3. **주문 조회**
   - 사용자별 주문 목록 (페이지네이션)
   - 주문 상세 정보 (주문 아이템, 배송 정보, 금액 내역)
   - 주문 상태별 필터링
   - 기간별 필터링

4. **주문 취소**
   - 취소 가능 상태: PENDING_PAYMENT, PAYMENT_COMPLETED
   - 취소 불가 상태: PREPARING 이상 (배송 준비 이후)
   - 취소 시 처리:
     - order_status → CANCELLED
     - 재고 복구 (stock_quantity 증가)
     - 적립금/예치금 환불 (Transaction 생성)
     - 쿠폰 복구 (isUsed = false)
     - 주문 생성 시 적립된 마일리지 회수
     - OrderStatusHistory에 취소 기록

**API Endpoints:**

- `POST /api/orders` - 주문 생성
  - Request body:
    - cartItemIds (주문할 장바구니 아이템 ID 배열)
    - shippingInfo (배송지 정보)
    - paymentMethod (결제 수단)
    - couponCode (선택)
    - mileageToUse (사용할 적립금)
    - depositToUse (사용할 예치금)
    - orderMemo (주문 메모)
  - Response: 생성된 주문 정보

- `POST /api/orders/{orderId}/payment` - 결제 처리 (스텁)
  - Response: 결제 완료 정보

- `GET /api/orders` - 주문 목록 조회
  - Query params: page, size, status, startDate, endDate
  - Response: 주문 목록 (페이지네이션)

- `GET /api/orders/{orderId}` - 주문 상세 조회
  - Response: 주문 상세 정보

- `PUT /api/orders/{orderId}/cancel` - 주문 취소
  - Request body: cancelReason
  - Response: 취소된 주문 정보

- `GET /api/orders/{orderId}/status-history` - 주문 상태 이력
  - Response: 상태 변경 이력 목록

**Error Handling:**

- 재고 부족: `INSUFFICIENT_STOCK`
- 쿠폰 사용 불가: `INVALID_COUPON`
- 적립금 부족: `INSUFFICIENT_MILEAGE`
- 예치금 부족: `INSUFFICIENT_DEPOSIT`
- 주문 없음: `ORDER_NOT_FOUND`
- 취소 불가: `CANNOT_CANCEL_ORDER`
- 최소 주문 금액 미달: `MINIMUM_ORDER_AMOUNT_NOT_MET`

#### Acceptance Criteria

- 주문 생성 시 모든 검증이 수행됨
- 재고가 정확하게 차감됨
- 쿠폰/적립금/예치금이 올바르게 적용됨
- 주문 취소 시 모든 항목이 복구됨
- 주문 상태 변경 이력이 기록됨

---

### [BE-036] 배송비 계산 로직 구현

**Priority**: 🔴 Critical
**Estimated Time**: 6 hours

#### Description

주문 금액과 배송 옵션에 따라 배송비를 계산하는 로직을 구현합니다. 외부 배송 API 연동 없이 로컬 로직으로 처리합니다.

#### Functional Requirements

**배송비 정책:**

1. **기본 배송비**
   - 기본 배송비: 3,000원
   - 무료배송 기준 금액: 50,000원 이상
   - 제주/도서산간: 추가 3,000원

2. **회원 등급별 혜택**
   - BASIC: 50,000원 이상 무료
   - VIP: 30,000원 이상 무료
   - WHOLESALE: 항상 무료

3. **배송 방식**
   - 일반 배송 (기본): +0원, 2-3일 소요
   - 새벽 배송: +5,000원, 다음날 오전 7시 전 도착
   - 예약 배송: +2,000원, 원하는 날짜/시간 지정

4. **지역별 추가 배송비**
   - 제주도: +3,000원
   - 도서산간: +3,000원
   - 우편번호 기반 판단:
     - 제주: 63000~63999
     - 도서산간: 별도 우편번호 목록 관리

**비즈니스 로직:**

1. **배송비 계산 함수**
   - 입력: 주문 금액, 회원 등급, 우편번호, 배송 방식
   - 처리:
     - 기본 배송비 설정
     - 회원 등급별 무료배송 기준 확인
     - 주문 금액이 기준 이상이면 배송비 0원
     - 배송 방식에 따른 추가 금액
     - 지역에 따른 추가 금액
   - 출력: 총 배송비, 무료배송까지 남은 금액

2. **우편번호 검증**
   - RemoteArea 테이블 생성
     - postal_code_prefix (우편번호 앞자리)
     - area_type (JEJU, ISLAND)
     - additional_fee (추가 배송비)
   - 우편번호 앞 3자리로 지역 판단

3. **배송비 미리보기**
   - 주문서 작성 단계에서 실시간 배송비 계산
   - 우편번호 입력 시 즉시 계산
   - 배송 방식 변경 시 즉시 재계산

**API Endpoints:**

- `POST /api/shipping/calculate` - 배송비 계산
  - Request body:
    - orderAmount (주문 금액)
    - postalCode (우편번호)
    - deliveryType (배송 방식: STANDARD, EARLY_MORNING, SCHEDULED)
    - membershipTier (회원 등급, 선택)
  - Response:
    - basicFee (기본 배송비)
    - deliveryTypeFee (배송 방식 추가 금액)
    - regionalFee (지역 추가 금액)
    - totalFee (총 배송비)
    - freeShippingThreshold (무료배송 기준 금액)
    - amountToFreeShipping (무료배송까지 남은 금액)

- `GET /api/shipping/remote-areas` - 도서산간 우편번호 목록
  - Response: 도서산간 지역 목록

**Error Handling:**

- 잘못된 우편번호: `INVALID_POSTAL_CODE`
- 배송 불가 지역: `DELIVERY_NOT_AVAILABLE`

#### Acceptance Criteria

- 주문 금액과 회원 등급에 따라 정확한 배송비 계산
- 제주/도서산간 추가 배송비 적용
- 배송 방식에 따른 금액 차이 반영
- 무료배송까지 남은 금액 계산

---

### [BE-037] 주문 상태 관리 시스템 구현

**Priority**: 🔴 Critical
**Estimated Time**: 8 hours

#### Description

주문의 상태를 체계적으로 관리하고 변경 이력을 추적하는 시스템을 구현합니다.

#### Functional Requirements

**주문 상태 흐름:**

```
PENDING_PAYMENT (결제 대기)
    ↓ (결제 완료)
PAYMENT_COMPLETED (결제 완료)
    ↓ (상품 준비 시작)
PREPARING (배송 준비중)
    ↓ (출고 완료)
SHIPPED (배송중)
    ↓ (배송 완료)
DELIVERED (배송 완료)

[취소/환불 플로우]
PENDING_PAYMENT/PAYMENT_COMPLETED → CANCELLED (주문 취소)
DELIVERED → REFUNDED (환불 완료)
```

**비즈니스 로직:**

1. **상태 변경 규칙**

   **사용자 가능 액션:**
   - PENDING_PAYMENT → CANCELLED (결제 전 취소)
   - PAYMENT_COMPLETED → CANCELLED (결제 후 24시간 내 취소)
   - DELIVERED → REFUND_REQUESTED (배송 완료 후 환불 신청)

   **관리자 가능 액션:**
   - PAYMENT_COMPLETED → PREPARING (배송 준비 시작)
   - PREPARING → SHIPPED (출고 처리)
   - SHIPPED → DELIVERED (배송 완료 처리)
   - REFUND_REQUESTED → REFUNDED (환불 승인)

2. **상태 변경 시 자동 처리**

   **PAYMENT_COMPLETED 진입 시:**
   - 적립금 적립 (회원 등급별 비율)
   - 주문 확인 알림 발송 예약
   - 재고 최종 차감 확인

   **PREPARING 진입 시:**
   - 송장번호 입력 가능 상태로 변경
   - 취소 불가 상태로 전환

   **SHIPPED 진입 시:**
   - 송장번호 필수 입력
   - 배송 추적 URL 생성
   - 배송 시작 알림 발송 예약

   **DELIVERED 진입 시:**
   - 구매 확정 예정일 설정 (7일 후)
   - 리뷰 작성 가능 상태로 변경
   - 배송 완료 알림 발송 예약
   - 누적 구매 금액 업데이트 (회원 등급 자동 업그레이드 판단)

   **CANCELLED 진입 시:**
   - 재고 복구
   - 적립금/예치금/쿠폰 환불
   - 결제 취소 처리 (Week 22-25에 실제 PG 취소)
   - 취소 완료 알림 발송 예약

3. **배송 정보 관리**

   **ShippingInfo 추가 필드 (Orders 테이블):**
   - carrier_company (택배사: CJ, 우체국, 로젠 등)
   - tracking_number (송장번호)
   - shipped_at (출고 시간)
   - delivered_at (배송 완료 시간)
   - estimated_delivery_date (배송 예정일)

   **배송 조회:**
   - 송장번호로 배송 상태 조회 (Week 22-25에 실제 API 연동)
   - 현재는 스텁 데이터 반환

4. **자동 구매 확정**
   - 배송 완료 후 7일이 지나면 자동 구매 확정
   - 스케줄러로 매일 1회 실행
   - 구매 확정 시 추가 적립금 지급 (상품 금액의 0.5%)

5. **주문 통계**
   - 사용자별 총 주문 수
   - 사용자별 총 구매 금액
   - 사용자별 주문 상태별 개수
   - 최근 3개월 구매 금액 (VIP 등급 판단용)

**API Endpoints:**

- `PUT /api/orders/{orderId}/status` - 주문 상태 변경 (관리자)
  - Request body:
    - newStatus (새로운 상태)
    - memo (변경 사유)
    - trackingNumber (송장번호, SHIPPED 시 필수)
    - carrierCompany (택배사, SHIPPED 시 필수)
  - Response: 변경된 주문 정보

- `GET /api/orders/{orderId}/tracking` - 배송 조회 (스텁)
  - Response:
    - trackingNumber (송장번호)
    - carrierCompany (택배사)
    - currentStatus (현재 배송 상태)
    - trackingEvents (배송 이력, 스텁 데이터)

- `POST /api/orders/{orderId}/confirm` - 구매 확정
  - Response: 확정된 주문 정보 + 추가 적립금 정보

- `GET /api/orders/stats` - 내 주문 통계
  - Response:
    - totalOrders (총 주문 수)
    - totalAmount (총 구매 금액)
    - statusCounts (상태별 주문 수)
    - recentThreeMonthsAmount (최근 3개월 구매액)

**스케줄러 작업:**

1. **자동 구매 확정 스케줄러**
   - 실행 주기: 매일 새벽 2시
   - 대상: delivered_at이 7일 이전이고 아직 확정되지 않은 주문
   - 처리: 구매 확정 + 추가 적립금 지급

2. **재고 알림 스케줄러**
   - 실행 주기: 매시간
   - 대상: 재입고 알림 신청한 위시리스트 + 재고가 0→양수로 변경된 상품
   - 처리: 재입고 알림 발송 예약

**Error Handling:**

- 잘못된 상태 전환: `INVALID_STATUS_TRANSITION`
- 권한 없음: `UNAUTHORIZED_STATUS_CHANGE`
- 송장번호 누락: `TRACKING_NUMBER_REQUIRED`

#### Acceptance Criteria

- 주문 상태가 정의된 규칙대로만 변경됨
- 상태 변경 시 자동 처리가 정확히 수행됨
- 배송 정보가 올바르게 관리됨
- 자동 구매 확정이 7일 후 실행됨
- 주문 통계가 정확하게 계산됨

---

### [BE-038] 결제 스텁 시스템 구현

**Priority**: 🟡 High
**Estimated Time**: 6 hours

#### Description

실제 PG 연동 없이 결제 프로세스를 시뮬레이션하는 스텁 시스템을 구현합니다. Week 22-25에서 실제 PG로 교체될 예정입니다.

#### Functional Requirements

**Payment Entity 설계:**

- id (PK, Auto Increment)
- order_id (FK to orders, not null)
- payment_method (결제 수단)
- payment_amount (결제 금액)
- payment_status (PENDING, COMPLETED, FAILED, CANCELLED, REFUNDED)
- transaction_id (가상 거래 ID, UUID)
- pg_response (PG 응답 데이터, JSONB - 스텁에서는 더미 데이터)
- paid_at (결제 완료 시간)
- cancelled_at (결제 취소 시간)
- created_at, updated_at

**결제 수단별 스텁 처리:**

1. **무통장 입금 (BANK_TRANSFER)**
   - 입금 대기 상태로 생성
   - 가상 입금 계좌 정보 반환
     - 은행명: 농협은행
     - 계좌번호: 302-XXXX-XXXX-XX (주문번호 기반 생성)
     - 예금주: (주)이송이
     - 입금 기한: 24시간
   - 관리자가 수동으로 입금 확인 처리
   - 입금 확인 시 payment_status → COMPLETED

2. **신용카드 (CREDIT_CARD)**
   - 즉시 결제 완료로 처리
   - 카드 정보는 저장하지 않음 (PCI-DSS 준수)
   - 가상 승인번호 생성
   - payment_status → COMPLETED

3. **카카오페이 (KAKAO_PAY)**
   - 즉시 결제 완료로 처리
   - 가상 거래 ID 생성
   - payment_status → COMPLETED

4. **네이버페이 (NAVER_PAY)**
   - 즉시 결제 완료로 처리
   - 가상 거래 ID 생성
   - payment_status → COMPLETED

5. **예치금 (DEPOSIT)**
   - 주문 생성 시 이미 차감 완료
   - 즉시 결제 완료로 처리
   - payment_status → COMPLETED

6. **적립금 (MILEAGE)**
   - 적립금만으로 전액 결제 시
   - 주문 생성 시 이미 차감 완료
   - 즉시 결제 완료로 처리
   - payment_status → COMPLETED

**비즈니스 로직:**

1. **결제 요청**
   - 주문 ID로 결제 대상 조회
   - 결제 금액 검증 (주문 금액과 일치)
   - Payment 레코드 생성 (status: PENDING)
   - 결제 수단별 처리 수행
   - 결제 완료 시:
     - Payment.payment_status → COMPLETED
     - Order.payment_status → COMPLETED
     - Order.order_status → PAYMENT_COMPLETED
     - 적립금 지급
     - OrderStatusHistory에 기록

2. **결제 취소**
   - 취소 가능 상태 확인 (COMPLETED만 가능)
   - Payment.payment_status → CANCELLED
   - Order.payment_status → PENDING (또는 CANCELLED)
   - 적립금/예치금 환불
   - 쿠폰 복구

3. **환불 처리**
   - 환불 신청 승인 시 호출
   - Payment.payment_status → REFUNDED
   - 환불 금액 계산 (부분 환불 지원)
   - 적립금/예치금으로 환불
   - 원 결제 수단으로 환불 (실제 PG 연동 시)

**API Endpoints:**

- `POST /api/payments/initiate` - 결제 요청
  - Request body:
    - orderId
    - paymentMethod
    - paymentAmount
  - Response: 결제 정보 (가상 계좌 또는 승인 정보)

- `POST /api/payments/{paymentId}/confirm` - 결제 확인 (무통장 입금용)
  - 관리자 전용
  - Request body: memo (입금 확인 메모)
  - Response: 확인된 결제 정보

- `POST /api/payments/{paymentId}/cancel` - 결제 취소
  - Request body: cancelReason
  - Response: 취소된 결제 정보

- `POST /api/payments/{paymentId}/refund` - 환불 처리
  - 관리자 전용
  - Request body: refundAmount, refundReason
  - Response: 환불 정보

- `GET /api/payments/order/{orderId}` - 주문의 결제 정보 조회
  - Response: 결제 상세 정보

**스텁 응답 예시:**

무통장 입금:

```
{
  "paymentMethod": "BANK_TRANSFER",
  "bankName": "농협은행",
  "accountNumber": "302-1234-5678-90",
  "accountHolder": "(주)이송이",
  "amount": 50000,
  "deadline": "2024-12-01T23:59:59",
  "message": "입금 시 입금자명을 주문번호(ORD-20241130-ABC123)로 입력해주세요"
}
```

카드 결제:

```
{
  "paymentMethod": "CREDIT_CARD",
  "transactionId": "STUB-TX-UUID",
  "approvalNumber": "12345678",
  "amount": 50000,
  "paidAt": "2024-11-30T15:30:00",
  "message": "결제가 완료되었습니다"
}
```

#### Acceptance Criteria

- 모든 결제 수단이 스텁으로 정상 작동
- 무통장 입금은 관리자 확인 후 완료
- 결제 취소/환불이 정상 처리됨
- Week 22-25에 실제 PG로 교체 가능한 구조

---

### [BE-039] 주문서 작성 및 검증 API 구현

**Priority**: 🔴 Critical
**Estimated Time**: 8 hours

#### Description

주문서 작성 단계에서 필요한 모든 정보를 제공하고 검증하는 API를 구현합니다.

#### Functional Requirements

**주문서 준비 정보:**

1. **장바구니 정보**
   - 선택된 장바구니 아이템 목록
   - 각 아이템의 상품 정보, 수량, 가격
   - 재고 상태

2. **사용자 정보**
   - 기본 배송지 정보
   - 저장된 배송지 목록
   - 회원 등급 정보

3. **할인 정보**
   - 사용 가능한 쿠폰 목록
   - 현재 적립금 잔액
   - 현재 예치금 잔액
   - 회원 등급 할인율

4. **배송 정보**
   - 배송 방식 목록 (일반/새벽/예약)
   - 기본 배송비
   - 무료배송 기준 금액

**주문서 검증:**

1. **상품 검증**
   - 모든 상품이 활성 상태인지
   - 재고가 충분한지
   - 품절 상품이 있는지

2. **금액 검증**
   - 쿠폰 적용 가능 여부 (최소 주문 금액)
   - 적립금 사용 가능 금액 (보유 금액 이하)
   - 예치금 사용 가능 금액 (보유 금액 이하)
   - 최종 결제 금액이 0원 이상인지

3. **배송지 검증**
   - 필수 정보 입력 확인
   - 우편번호 유효성 검증
   - 전화번호 형식 검증

4. **결제 수단 검증**
   - 선택한 결제 수단이 유효한지
   - 예치금/적립금 전액 결제 시 잔액 확인

**비즈니스 로직:**

1. **주문서 조회**
   - 장바구니 아이템 ID 배열 받기
   - 각 아이템의 최신 정보 조회
   - 재고 상태 확인
   - 총 상품 금액 계산
   - 사용 가능한 쿠폰 필터링
   - 적용 가능한 할인 계산
   - 배송비 계산 (기본 배송지 기준)
   - 최종 예상 금액 계산

2. **주문 금액 미리보기**
   - 쿠폰 적용 시뮬레이션
   - 적립금 사용 시뮬레이션
   - 예치금 사용 시뮬레이션
   - 배송비 재계산
   - 최종 결제 금액 계산
   - 적립 예정 마일리지 계산

3. **배송지 우편번호 조회**
   - 우편번호로 주소 검색 (카카오 주소 API 연동은 Week 22-25)
   - 현재는 간단한 더미 데이터 반환

**API Endpoints:**

- `POST /api/orders/checkout` - 주문서 정보 조회
  - Request body: cartItemIds (배열)
  - Response:
    - items (상품 목록)
    - user (사용자 정보)
    - addresses (배송지 목록)
    - availableCoupons (사용 가능한 쿠폰 목록)
    - mileageBalance (적립금 잔액)
    - depositBalance (예치금 잔액)
    - membershipTier (회원 등급)
    - shipping (배송 정보)
    - summary (금액 요약)

- `POST /api/orders/calculate` - 주문 금액 계산
  - Request body:
    - cartItemIds
    - shippingInfo (배송지 정보)
    - deliveryType (배송 방식)
    - couponCode (선택)
    - mileageToUse (선택)
    - depositToUse (선택)
  - Response:
    - subtotal (상품 금액)
    - shippingFee (배송비)
    - couponDiscount (쿠폰 할인)
    - mileageDiscount (적립금 할인)
    - depositDiscount (예치금 할인)
    - membershipDiscount (회원 할인)
    - totalAmount (최종 금액)
    - expectedMileage (적립 예정 마일리지)

- `POST /api/orders/validate` - 주문 검증
  - Request body: 주문 정보 전체
  - Response:
    - valid (검증 결과: true/false)
    - errors (에러 목록)
      - code (에러 코드)
      - message (에러 메시지)
      - field (해당 필드)

**Error Handling:**

- 품절 상품: `PRODUCT_OUT_OF_STOCK`
- 재고 부족: `INSUFFICIENT_STOCK`
- 쿠폰 사용 불가: `COUPON_NOT_APPLICABLE`
- 최소 주문 금액 미달: `MINIMUM_ORDER_NOT_MET`
- 잘못된 배송지: `INVALID_SHIPPING_INFO`
- 결제 금액 불일치: `PAYMENT_AMOUNT_MISMATCH`

#### Acceptance Criteria

- 주문서에 필요한 모든 정보가 한 번에 조회됨
- 금액 계산이 정확하게 수행됨
- 모든 검증이 주문 생성 전에 수행됨
- 프론트엔드에서 실시간으로 금액 확인 가능

---

## 📊 Week 13-17 Summary

### Deliverables

- ✅ 장바구니 시스템 (로그인/게스트, 병합)
- ✅ 주문 생성 및 관리
- ✅ 결제 스텁 시스템
- ✅ 배송비 계산 로직
- ✅ 주문 상태 관리 및 이력
- ✅ 주문서 작성 및 검증

### Key Endpoints (Week 13-17)

**장바구니:**

- `GET /api/cart` - 장바구니 조회
- `POST /api/cart` - 장바구니 추가
- `PUT /api/cart/{id}` - 수량 수정
- `DELETE /api/cart/{id}` - 아이템 삭제
- `POST /api/cart/merge` - 게스트 장바구니 병합

**주문:**

- `POST /api/orders` - 주문 생성
- `GET /api/orders` - 주문 목록
- `GET /api/orders/{id}` - 주문 상세
- `PUT /api/orders/{id}/cancel` - 주문 취소
- `PUT /api/orders/{id}/status` - 상태 변경 (관리자)
- `POST /api/orders/{id}/confirm` - 구매 확정
- `GET /api/orders/stats` - 주문 통계

**배송:**

- `POST /api/shipping/calculate` - 배송비 계산
- `GET /api/shipping/remote-areas` - 도서산간 지역 목록
- `GET /api/orders/{id}/tracking` - 배송 조회 (스텁)

**결제:**

- `POST /api/payments/initiate` - 결제 요청
- `POST /api/payments/{id}/confirm` - 결제 확인
- `POST /api/payments/{id}/cancel` - 결제 취소
- `POST /api/payments/{id}/refund` - 환불 처리

**주문서:**

- `POST /api/orders/checkout` - 주문서 정보 조회
- `POST /api/orders/calculate` - 금액 계산
- `POST /api/orders/validate` - 주문 검증

### Database Schema

- `cart_items` - 장바구니 아이템
- `orders` - 주문 정보
- `order_items` - 주문 상품
- `order_status_history` - 주문 상태 이력
- `payments` - 결제 정보
- `remote_areas` - 도서산간 지역

### Frontend Integration Ready (Week 13+)

- 장바구니 페이지
- 주문서 작성 페이지
- 결제 페이지
- 주문 완료 페이지
- 주문 내역 페이지
- 주문 상세 페이지

### 외부 연동 미포함 (Week 22-25에 구현 예정)

- ❌ 실제 PG 결제 (현재: 스텁)
- ❌ 우편번호 API (현재: 더미 데이터)
- ❌ 배송 추적 API (현재: 스텁)
- ❌ 결제 완료 이메일 (현재: 예약만)
- ❌ 알림톡/SMS (현재: 예약만)

### Next Steps (Week 18-21)

- 반품/교환 시스템
- 고객 문의 (Q&A)
- 공지사항 및 FAQ
- 1:1 문의

---

**Note**: 모든 스텁 시스템은 Week 22-25에 실제 외부 API로 교체 가능하도록 인터페이스 기반으로 설계되어야 합니다.
