# Week 18-21: 주문 관리 및 고객 서비스

**기간**: Week 18-21
**목표**: 반품/교환, 고객 문의, 공지사항/FAQ, 1:1 문의 시스템 구현
**프론트엔드 연동**: Week 18부터 시작

---

## 📋 Issue Tickets

### [BE-040] 반품 시스템 구현

**Priority**: 🔴 Critical
**Estimated Time**: 10 hours

#### Description

고객이 배송 완료된 상품에 대해 반품을 신청하고, 관리자가 승인/거부할 수 있는 시스템을 구현합니다.

#### Functional Requirements

**Return Entity 설계:**

- id (Primary Key, Auto Increment)
- return_number (반품 번호, 자동 생성: "RET-YYYYMMDD-6자리난수", Unique)
- order_id (FK to orders, not null)
- user_id (FK to users, not null)
- return_status (Enum: REQUESTED, APPROVED, REJECTED, PICKUP_SCHEDULED, PICKED_UP, INSPECTING, COMPLETED, CANCELLED)
- return_reason (반품 사유 카테고리: DEFECTIVE, WRONG_ITEM, CHANGE_OF_MIND, SIZE_ISSUE, OTHER)
- detailed_reason (상세 사유, Text)
- refund_method (환불 방법: ORIGINAL_PAYMENT, MILEAGE, DEPOSIT)
- refund_amount (환불 금액)
- return_shipping_fee (반품 배송비, 고객 부담/판매자 부담)
- admin_memo (관리자 메모)
- processed_by (처리한 관리자 ID, nullable)
- created_at, updated_at
- approved_at, rejected_at, completed_at

**ReturnItem Entity 설계:**

- id (Primary Key, Auto Increment)
- return_id (FK to returns, not null)
- order_item_id (FK to order_items, not null)
- quantity (반품 수량)
- reason (개별 아이템 사유, nullable)

**ReturnImage Entity 설계:**

- id (Primary Key, Auto Increment)
- return_id (FK to returns, not null)
- image_url (이미지 URL, AWS S3)
- description (이미지 설명)
- display_order (표시 순서)

**비즈니스 로직:**

1. **반품 신청 가능 조건**
   - 주문 상태가 DELIVERED (배송 완료)
   - 배송 완료일로부터 7일 이내
   - 이미 반품/교환 신청하지 않은 주문
   - 구매 확정하지 않은 주문

2. **반품 신청 프로세스**

   **Step 1: 반품 가능 여부 확인**
   - 주문 ID로 주문 조회
   - 위 조건들 검증
   - 반품 불가 사유 반환

   **Step 2: 반품 신청 정보 입력**
   - 반품할 상품 선택 (전체 또는 일부)
   - 각 상품별 반품 수량 선택
   - 반품 사유 선택 (카테고리 + 상세 내용)
   - 불량/오배송인 경우 사진 업로드 (최대 5장)
   - 환불 방법 선택

   **Step 3: 반품 접수**
   - Return 레코드 생성 (status: REQUESTED)
   - ReturnItem 레코드 생성 (선택한 아이템들)
   - ReturnImage 레코드 생성 (업로드한 사진들)
   - 반품 배송비 계산
     - 고객 변심: 3,000원 (고객 부담)
     - 불량/오배송: 0원 (판매자 부담)
   - 반품 신청 완료 알림 발송 예약

3. **반품 승인/거부 (관리자)**

   **승인 시:**
   - return_status → APPROVED
   - 수거 일정 안내 (택배사 연락 예정)
   - 고객에게 반품 승인 알림 발송
   - return_status → PICKUP_SCHEDULED

   **거부 시:**
   - return_status → REJECTED
   - 거부 사유 입력 (admin_memo)
   - 고객에게 거부 알림 및 사유 발송

4. **반품 진행 상태 업데이트**

   **수거 완료:**
   - return_status → PICKED_UP
   - 수거 완료 알림 발송

   **검수 중:**
   - return_status → INSPECTING
   - 상품 상태 검수
   - 반품 사유와 실제 상품 상태 확인

   **반품 완료:**
   - return_status → COMPLETED
   - 재고 복구 (반품된 수량만큼 증가)
   - 환불 처리
     - 원 결제 수단: Payment 테이블에 환불 기록
     - 적립금: MileageTransaction 생성
     - 예치금: DepositTransaction 생성
   - 주문 적립 마일리지 회수
   - 반품 배송비 차감 (고객 부담인 경우)
   - Order.order_status → REFUNDED (전체 반품) 또는 PARTIAL_REFUND (부분 반품)
   - 반품 완료 알림 발송

5. **반품 취소 (고객)**
   - 취소 가능 상태: REQUESTED, APPROVED
   - 취소 불가 상태: PICKED_UP 이상
   - return_status → CANCELLED

**API Endpoints:**

- `GET /api/orders/{orderId}/return-eligibility` - 반품 가능 여부 조회
  - Response:
    - eligible (true/false)
    - reason (불가 사유)
    - deadline (반품 신청 마감일)
    - returnableItems (반품 가능한 아이템 목록)

- `POST /api/returns` - 반품 신청
  - Request body:
    - orderId
    - items (배열: orderItemId, quantity, reason)
    - returnReason (카테고리)
    - detailedReason (상세 사유)
    - refundMethod
    - images (이미지 URL 배열, 선택)
  - Response: 생성된 반품 정보

- `GET /api/returns` - 내 반품 목록
  - Query params: page, size, status
  - Response: 반품 목록 (페이지네이션)

- `GET /api/returns/{returnId}` - 반품 상세 조회
  - Response:
    - returnInfo (반품 정보)
    - order (주문 정보)
    - items (반품 아이템 목록)
    - images (첨부 이미지)
    - timeline (상태 변경 이력)

- `PUT /api/returns/{returnId}/cancel` - 반품 취소
  - Request body: cancelReason
  - Response: 취소된 반품 정보

- `PUT /api/returns/{returnId}/status` - 반품 상태 변경 (관리자)
  - Request body:
    - newStatus
    - adminMemo
  - Response: 변경된 반품 정보

**Error Handling:**

- 반품 기간 초과: `RETURN_PERIOD_EXPIRED`
- 이미 반품 신청: `RETURN_ALREADY_REQUESTED`
- 반품 불가 상태: `RETURN_NOT_ELIGIBLE`
- 반품 취소 불가: `CANNOT_CANCEL_RETURN`

#### Acceptance Criteria

- 배송 완료 후 7일 이내만 반품 가능
- 전체 또는 부분 반품 모두 지원
- 관리자 승인/거부 프로세스 정상 작동
- 반품 완료 시 재고 및 금액 정확히 처리
- 상태별 알림 발송 예약 정상 작동

---

### [BE-041] 교환 시스템 구현

**Priority**: 🔴 Critical
**Estimated Time**: 10 hours

#### Description

고객이 배송 완료된 상품을 다른 옵션이나 다른 상품으로 교환할 수 있는 시스템을 구현합니다.

#### Functional Requirements

**Exchange Entity 설계:**

- id (Primary Key, Auto Increment)
- exchange_number (교환 번호, "EXC-YYYYMMDD-6자리난수", Unique)
- order_id (FK to orders, not null)
- user_id (FK to users, not null)
- exchange_status (Enum: REQUESTED, APPROVED, REJECTED, PICKUP_SCHEDULED, PICKED_UP, INSPECTING, SHIPPING_REPLACEMENT, COMPLETED, CANCELLED)
- exchange_reason (사유: DEFECTIVE, WRONG_ITEM, SIZE_CHANGE, COLOR_CHANGE, OTHER)
- detailed_reason (상세 사유)
- exchange_shipping_fee (교환 배송비)
- additional_payment (추가 결제 금액, 교환 상품이 더 비싼 경우)
- refund_amount (환불 금액, 교환 상품이 더 저렴한 경우)
- replacement_order_id (교환 상품 주문 ID, nullable)
- admin_memo
- processed_by
- created_at, updated_at
- approved_at, rejected_at, completed_at

**ExchangeItem Entity 설계:**

- id (Primary Key, Auto Increment)
- exchange_id (FK to exchanges, not null)
- order_item_id (원본 주문 아이템 ID)
- quantity (교환 수량)
- replacement_product_id (교환할 상품 ID)
- replacement_options (교환할 상품 옵션, JSONB)
- replacement_quantity (교환 받을 수량)
- price_difference (가격 차이)

**비즈니스 로직:**

1. **교환 신청 가능 조건**
   - 반품과 동일: 배송 완료 후 7일 이내
   - 주문 상태: DELIVERED
   - 교환할 상품의 재고 확인 필요

2. **교환 신청 프로세스**

   **Step 1: 교환 상품 선택**
   - 원본 상품 선택 (주문 아이템에서)
   - 교환 수량 선택
   - 교환할 상품/옵션 선택
     - 동일 상품 다른 옵션 (사이즈, 색상 등)
     - 완전히 다른 상품
   - 교환 상품 재고 확인

   **Step 2: 금액 계산**
   - 원본 상품 가격 × 수량 = A
   - 교환 상품 가격 × 수량 = B
   - 가격 차이 = B - A
   - 추가 결제 필요: B > A인 경우
   - 환불 필요: B < A인 경우

   **Step 3: 교환 신청 접수**
   - Exchange 레코드 생성
   - ExchangeItem 레코드 생성
   - 교환 배송비 계산 (불량/오배송: 무료, 변심: 왕복 6,000원)
   - 추가 결제 필요 시 결제 링크 생성 (스텁)
   - 교환 신청 알림 발송

3. **교환 승인/거부 (관리자)**

   **승인 시:**
   - 교환 상품 재고 확인 및 예약
   - exchange_status → APPROVED
   - 추가 결제 필요 시 결제 안내
   - 수거 일정 안내
   - exchange_status → PICKUP_SCHEDULED

   **거부 시:**
   - 재고 부족, 교환 불가 상품 등
   - exchange_status → REJECTED
   - 거부 사유 전달

4. **교환 진행**

   **원본 상품 수거:**
   - exchange_status → PICKED_UP
   - 검수 시작

   **검수 완료:**
   - exchange_status → INSPECTING
   - 상품 상태 확인
   - 교환 가능 여부 최종 판단

   **교환 상품 발송:**
   - exchange_status → SHIPPING_REPLACEMENT
   - 새로운 주문 생성 (replacement_order_id에 저장)
   - 재고 처리:
     - 원본 상품: 재고 복구
     - 교환 상품: 재고 차감
   - 교환 상품 송장번호 등록
   - 발송 알림 전송

   **교환 완료:**
   - 교환 상품 배송 완료
   - exchange_status → COMPLETED
   - 가격 차이 정산:
     - 추가 결제분: Payment 레코드 생성
     - 환불분: 원 결제 수단으로 환불 (스텁)
   - 교환 완료 알림 발송

5. **교환 취소**
   - 취소 가능: REQUESTED, APPROVED 상태
   - exchange_status → CANCELLED

**API Endpoints:**

- `GET /api/orders/{orderId}/exchange-eligibility` - 교환 가능 여부
  - Response:
    - eligible
    - reason
    - deadline
    - exchangeableItems

- `GET /api/products/{productId}/exchange-options` - 교환 가능 옵션 조회
  - 동일 상품의 다른 옵션 목록
  - 재고 상태 포함

- `POST /api/exchanges` - 교환 신청
  - Request body:
    - orderId
    - items (배열: originalOrderItemId, quantity, replacementProductId, replacementOptions, replacementQuantity)
    - exchangeReason
    - detailedReason
    - images (선택)
  - Response:
    - exchangeInfo
    - priceDifference
    - additionalPaymentRequired (추가 결제 필요 여부)
    - paymentLink (추가 결제 링크, 스텁)

- `GET /api/exchanges` - 내 교환 목록
  - Query params: page, size, status
  - Response: 교환 목록

- `GET /api/exchanges/{exchangeId}` - 교환 상세
  - Response:
    - exchangeInfo
    - originalOrder (원본 주문)
    - originalItems (원본 아이템)
    - replacementItems (교환 아이템)
    - replacementOrder (교환 상품 주문, 발송 후)
    - timeline

- `PUT /api/exchanges/{exchangeId}/cancel` - 교환 취소
  - Request body: cancelReason
  - Response: 취소 정보

- `PUT /api/exchanges/{exchangeId}/status` - 교환 상태 변경 (관리자)
  - Request body: newStatus, adminMemo
  - Response: 변경된 교환 정보

- `POST /api/exchanges/{exchangeId}/ship-replacement` - 교환 상품 발송 (관리자)
  - Request body:
    - trackingNumber
    - carrierCompany
  - Response: 발송 정보

**Error Handling:**

- 교환 기간 초과: `EXCHANGE_PERIOD_EXPIRED`
- 교환 상품 품절: `REPLACEMENT_OUT_OF_STOCK`
- 추가 결제 실패: `ADDITIONAL_PAYMENT_FAILED`
- 교환 취소 불가: `CANNOT_CANCEL_EXCHANGE`

#### Acceptance Criteria

- 교환 신청 시 교환 상품 재고 확인
- 가격 차이 정확히 계산 및 정산
- 원본 상품 수거 → 검수 → 교환 상품 발송 프로세스 정상 작동
- 재고 처리 정확 (원본 복구, 교환 차감)

---

### [BE-042] 상품 Q&A 시스템 구현

**Priority**: 🟡 High
**Estimated Time**: 8 hours

#### Description

고객이 상품에 대해 질문하고 관리자가 답변하는 Q&A 시스템을 구현합니다.

#### Functional Requirements

**ProductQuestion Entity 설계:**

- id (Primary Key, Auto Increment)
- product_id (FK to products, not null)
- user_id (FK to users, not null)
- question_title (제목, 50자 제한)
- question_content (질문 내용, Text)
- is_secret (비밀글 여부, Boolean, default false)
- answer_content (답변 내용, Text, nullable)
- answered_by (답변자 ID, nullable)
- answered_at (답변 시간, nullable)
- is_answered (답변 여부, Boolean, default false)
- view_count (조회수)
- created_at, updated_at

**비즈니스 로직:**

1. **질문 작성**
   - 로그인 필수
   - 상품 ID 필수
   - 제목: 최소 5자, 최대 50자
   - 내용: 최소 10자, 최대 1000자
   - 비밀글 설정 가능
   - 질문 등록 시 상품 판매자에게 알림

2. **질문 목록 조회**

   **전체 공개 질문:**
   - 비밀글 아닌 질문만 표시
   - 페이지네이션 지원
   - 최신순 정렬
   - 답변 여부로 필터링 가능

   **내 질문 (로그인 사용자):**
   - 본인이 작성한 모든 질문 (비밀글 포함)
   - 답변 여부, 기간으로 필터링

   **비밀글 조회 권한:**
   - 작성자 본인만 조회 가능
   - 관리자도 조회 가능
   - 타인이 조회 시 "비밀글입니다" 표시

3. **질문 상세 조회**
   - 조회수 증가
   - 비밀글인 경우 권한 확인
   - 답변이 있으면 함께 표시

4. **답변 작성 (관리자)**
   - 질문에 답변 내용 추가
   - is_answered → true
   - answered_at 설정
   - 질문 작성자에게 답변 알림 발송

5. **질문 수정/삭제**
   - 수정/삭제 가능: 본인 작성, 답변 없는 경우만
   - 답변 있으면 수정/삭제 불가

**API Endpoints:**

- `GET /api/products/{productId}/questions` - 상품 Q&A 목록
  - Query params:
    - page, size
    - answered (전체/답변완료/미답변)
  - Response: Q&A 목록 (비밀글은 제목만, 내용 숨김)

- `POST /api/questions` - 질문 작성
  - Request body:
    - productId
    - questionTitle
    - questionContent
    - isSecret
  - Response: 생성된 질문 정보

- `GET /api/questions/{questionId}` - 질문 상세
  - 비밀글 권한 확인
  - Response:
    - question (질문 정보)
    - answer (답변 정보, 있는 경우)
    - product (상품 간략 정보)

- `PUT /api/questions/{questionId}` - 질문 수정
  - 본인 확인, 답변 없는 경우만
  - Request body: questionTitle, questionContent, isSecret
  - Response: 수정된 질문

- `DELETE /api/questions/{questionId}` - 질문 삭제
  - 본인 확인, 답변 없는 경우만
  - Response: 성공 메시지

- `GET /api/users/questions` - 내 질문 목록
  - Query params: page, size, answered
  - Response: 내가 작성한 질문 목록

- `POST /api/questions/{questionId}/answer` - 답변 작성 (관리자)
  - Request body: answerContent
  - Response: 답변 정보

- `PUT /api/questions/{questionId}/answer` - 답변 수정 (관리자)
  - Request body: answerContent
  - Response: 수정된 답변

**Error Handling:**

- 비밀글 접근 권한 없음: `FORBIDDEN_SECRET_QUESTION`
- 답변 있는 질문 수정/삭제: `CANNOT_MODIFY_ANSWERED_QUESTION`
- 질문 없음: `QUESTION_NOT_FOUND`

#### Acceptance Criteria

- 비밀글 권한 제어 정확히 작동
- 답변 알림 발송 정상 작동
- 상품 페이지에서 Q&A 조회 가능
- 내 질문 목록 별도 조회 가능

---

### [BE-043] 공지사항 및 FAQ 시스템 구현

**Priority**: 🟡 High
**Estimated Time**: 6 hours

#### Description

관리자가 공지사항을 게시하고 자주 묻는 질문(FAQ)을 관리하는 시스템을 구현합니다.

#### Functional Requirements

**Notice Entity 설계:**

- id (Primary Key, Auto Increment)
- title (제목, not null, 100자 제한)
- content (내용, Text, not null)
- category (카테고리: GENERAL, EVENT, MAINTENANCE, POLICY, PRODUCT)
- is_important (중요 공지 여부, Boolean)
- is_pinned (상단 고정 여부, Boolean)
- view_count (조회수)
- attachments (첨부파일 URL 배열, JSONB, nullable)
- published_at (게시 시작 시간)
- expires_at (게시 종료 시간, nullable)
- created_by (작성자 ID)
- created_at, updated_at

**FAQ Entity 설계:**

- id (Primary Key, Auto Increment)
- category (카테고리: ORDER, PAYMENT, DELIVERY, RETURN, PRODUCT, MEMBERSHIP, OTHER)
- question (질문, not null, 200자 제한)
- answer (답변, Text, not null)
- display_order (표시 순서, 낮을수록 상위)
- view_count (조회수)
- is_active (활성 여부)
- created_by
- created_at, updated_at

**비즈니스 로직:**

1. **공지사항 관리**

   **게시:**
   - 관리자만 작성 가능
   - 제목, 내용 필수
   - 카테고리 선택
   - 중요 공지 설정 (메인 페이지 노출)
   - 상단 고정 설정 (최대 3개)
   - 게시 기간 설정 (시작일, 종료일)
   - 첨부 파일 업로드 (최대 5개, 각 10MB 이하)

   **조회:**
   - 모든 사용자 조회 가능
   - 게시 기간 내 공지만 표시
   - 상단 고정 공지가 최상단
   - 그 다음 중요 공지
   - 나머지는 최신순
   - 페이지네이션
   - 카테고리별 필터링

   **상세:**
   - 조회수 증가
   - 이전/다음 공지 링크 제공

2. **FAQ 관리**

   **등록:**
   - 관리자만 작성 가능
   - 카테고리별로 분류
   - display_order로 순서 지정
   - 드래그 앤 드롭으로 순서 변경 가능 (프론트엔드)

   **조회:**
   - 카테고리별로 accordion 형태로 표시
   - 활성화된 FAQ만 표시
   - display_order 순으로 정렬
   - 검색 기능 (질문/답변 전체 검색)

3. **검색 기능**
   - 공지사항과 FAQ 통합 검색
   - 제목, 내용에서 키워드 검색
   - 검색 결과 하이라이팅

**API Endpoints:**

**공지사항:**

- `GET /api/notices` - 공지사항 목록
  - Query params:
    - page, size
    - category
    - important (중요 공지만)
  - Response: 공지사항 목록
    - pinned (상단 고정 공지 배열)
    - important (중요 공지 배열)
    - normal (일반 공지, 페이지네이션)

- `GET /api/notices/{noticeId}` - 공지사항 상세
  - Response:
    - notice (공지사항 정보)
    - prev (이전 공지)
    - next (다음 공지)

- `POST /api/notices` - 공지사항 작성 (관리자)
  - Request body:
    - title
    - content
    - category
    - isImportant
    - isPinned
    - publishedAt
    - expiresAt
    - attachments
  - Response: 생성된 공지사항

- `PUT /api/notices/{noticeId}` - 공지사항 수정 (관리자)
  - Request body: (동일)
  - Response: 수정된 공지사항

- `DELETE /api/notices/{noticeId}` - 공지사항 삭제 (관리자)
  - Response: 성공 메시지

**FAQ:**

- `GET /api/faq` - FAQ 목록
  - Query params:
    - category (선택)
    - keyword (검색어, 선택)
  - Response:
    - categories (카테고리별 FAQ 그룹)
      - category
      - faqs (배열)

- `GET /api/faq/{faqId}` - FAQ 상세
  - Response: FAQ 정보

- `POST /api/faq` - FAQ 작성 (관리자)
  - Request body:
    - category
    - question
    - answer
    - displayOrder
  - Response: 생성된 FAQ

- `PUT /api/faq/{faqId}` - FAQ 수정 (관리자)
  - Request body: (동일)
  - Response: 수정된 FAQ

- `DELETE /api/faq/{faqId}` - FAQ 삭제 (관리자)
  - Response: 성공 메시지

- `PUT /api/faq/reorder` - FAQ 순서 변경 (관리자)
  - Request body: faqOrders (배열: faqId, newOrder)
  - Response: 성공 메시지

**검색:**

- `GET /api/support/search` - 공지사항 및 FAQ 통합 검색
  - Query params:
    - q (검색어)
    - type (notice, faq, all)
    - page, size
  - Response:
    - notices (공지사항 검색 결과)
    - faqs (FAQ 검색 결과)

**Error Handling:**

- 관리자 권한 필요: `ADMIN_ONLY`
- 상단 고정 제한 초과: `MAX_PINNED_EXCEEDED`

#### Acceptance Criteria

- 공지사항 게시 기간 자동 관리
- 상단 고정 최대 3개 제한
- FAQ 카테고리별 그룹화
- 통합 검색 기능 정상 작동

---

### [BE-044] 1:1 문의 시스템 구현

**Priority**: 🟡 High
**Estimated Time**: 8 hours

#### Description

고객이 1:1로 문의하고 관리자가 답변하는 시스템을 구현합니다.

#### Functional Requirements

**Inquiry Entity 설계:**

- id (Primary Key, Auto Increment)
- inquiry_number (문의 번호, "INQ-YYYYMMDD-6자리난수", Unique)
- user_id (FK to users, nullable - 비회원도 가능)
- inquiry_type (문의 유형: ORDER, PRODUCT, DELIVERY, RETURN, PAYMENT, MEMBERSHIP, OTHER)
- title (제목, not null)
- content (내용, Text, not null)
- email (이메일, 비회원용)
- phone (전화번호, 선택)
- order_number (관련 주문번호, 선택)
- status (상태: PENDING, IN_PROGRESS, ANSWERED, CLOSED)
- answer_content (답변 내용, Text, nullable)
- answered_by (답변자 ID)
- answered_at
- is_email_sent (답변 이메일 발송 여부)
- created_at, updated_at

**InquiryAttachment Entity 설계:**

- id (Primary Key, Auto Increment)
- inquiry_id (FK to inquiries, not null)
- file_url (파일 URL, AWS S3)
- file_name (원본 파일명)
- file_size (파일 크기, bytes)
- file_type (파일 타입)
- created_at

**비즈니스 로직:**

1. **문의 작성**

   **회원:**
   - 로그인 정보로 자동 입력
   - 이메일, 전화번호 자동 채움
   - 최근 주문 목록에서 선택 가능

   **비회원:**
   - 이메일 필수 입력 (답변 받을 이메일)
   - 전화번호 선택 입력
   - 주문번호 직접 입력 (있는 경우)

   **공통:**
   - 문의 유형 선택
   - 제목 (5~100자)
   - 내용 (10~2000자)
   - 파일 첨부 (최대 3개, 각 5MB 이하)
   - 문의 접수 후 inquiry_number 발급
   - 접수 확인 이메일 발송 (비동기)

2. **문의 목록 조회**

   **회원:**
   - 본인이 작성한 문의만 조회
   - 상태별 필터링
   - 답변 여부로 필터링

   **비회원:**
   - 문의번호 + 이메일로 조회
   - 해당하는 문의 1건만 반환

   **관리자:**
   - 모든 문의 조회
   - 상태별, 유형별 필터링
   - 미답변 문의 우선 표시

3. **문의 상세 조회**
   - 회원: 본인 문의만
   - 비회원: 문의번호 + 이메일 일치 시
   - 관리자: 모두 가능

4. **답변 작성 (관리자)**
   - status → IN_PROGRESS
   - 답변 내용 작성
   - 답변 완료 시:
     - status → ANSWERED
     - answered_at 설정
     - 사용자에게 답변 이메일 발송 (비동기)
     - is_email_sent → true

5. **문의 상태 관리**
   - PENDING: 접수 대기
   - IN_PROGRESS: 처리 중
   - ANSWERED: 답변 완료
   - CLOSED: 종결 (고객 확인 또는 7일 경과)

6. **자동 종결**
   - 답변 후 7일이 지나면 자동으로 CLOSED
   - 스케줄러로 매일 1회 실행

**API Endpoints:**

- `POST /api/inquiries` - 문의 작성
  - Request body:
    - inquiryType
    - title
    - content
    - email (비회원 필수)
    - phone (선택)
    - orderNumber (선택)
    - attachments (파일 URL 배열)
  - Response:
    - inquiryNumber
    - message ("문의가 접수되었습니다")

- `GET /api/inquiries` - 내 문의 목록 (회원)
  - Query params:
    - page, size
    - status
    - type
  - Response: 문의 목록

- `GET /api/inquiries/guest` - 문의 조회 (비회원)
  - Query params:
    - inquiryNumber
    - email
  - Response: 문의 상세 (1건)

- `GET /api/inquiries/{inquiryId}` - 문의 상세 (회원)
  - Response:
    - inquiry (문의 정보)
    - attachments (첨부 파일 목록)
    - answer (답변, 있는 경우)

- `POST /api/inquiries/{inquiryId}/answer` - 답변 작성 (관리자)
  - Request body:
    - answerContent
    - sendEmail (이메일 발송 여부, default true)
  - Response: 답변 정보

- `PUT /api/inquiries/{inquiryId}/answer` - 답변 수정 (관리자)
  - Request body: answerContent
  - Response: 수정된 답변

- `PUT /api/inquiries/{inquiryId}/status` - 상태 변경 (관리자)
  - Request body: newStatus
  - Response: 변경된 문의 정보

- `GET /api/inquiries/stats` - 문의 통계 (관리자)
  - Response:
    - totalInquiries
    - pendingCount
    - inProgressCount
    - answeredCount
    - todayInquiries

**스케줄러:**

- 자동 종결 스케줄러
  - 매일 새벽 3시 실행
  - ANSWERED 상태이고 answered_at이 7일 이전인 문의
  - status → CLOSED

**Error Handling:**

- 비회원 조회 실패: `INQUIRY_NOT_FOUND_OR_EMAIL_MISMATCH`
- 권한 없음: `UNAUTHORIZED_INQUIRY_ACCESS`
- 파일 크기 초과: `FILE_SIZE_EXCEEDED`

#### Acceptance Criteria

- 회원/비회원 모두 문의 가능
- 비회원은 문의번호+이메일로만 조회 가능
- 답변 시 이메일 자동 발송
- 7일 후 자동 종결

---

## 📊 Week 18-21 Summary

### Deliverables

- ✅ 반품 시스템
- ✅ 교환 시스템
- ✅ 상품 Q&A
- ✅ 공지사항 및 FAQ
- ✅ 1:1 문의

### Key Endpoints (Week 18-21)

**반품:**

- `GET /api/orders/{orderId}/return-eligibility` - 반품 가능 여부
- `POST /api/returns` - 반품 신청
- `GET /api/returns` - 내 반품 목록
- `GET /api/returns/{id}` - 반품 상세
- `PUT /api/returns/{id}/cancel` - 반품 취소
- `PUT /api/returns/{id}/status` - 상태 변경 (관리자)

**교환:**

- `GET /api/orders/{orderId}/exchange-eligibility` - 교환 가능 여부
- `GET /api/products/{id}/exchange-options` - 교환 옵션
- `POST /api/exchanges` - 교환 신청
- `GET /api/exchanges` - 내 교환 목록
- `GET /api/exchanges/{id}` - 교환 상세
- `PUT /api/exchanges/{id}/cancel` - 교환 취소
- `POST /api/exchanges/{id}/ship-replacement` - 교환 상품 발송 (관리자)

**상품 Q&A:**

- `GET /api/products/{id}/questions` - 상품 Q&A 목록
- `POST /api/questions` - 질문 작성
- `GET /api/questions/{id}` - 질문 상세
- `PUT /api/questions/{id}` - 질문 수정
- `POST /api/questions/{id}/answer` - 답변 작성 (관리자)

**공지사항:**

- `GET /api/notices` - 공지사항 목록
- `GET /api/notices/{id}` - 공지사항 상세
- `POST /api/notices` - 작성 (관리자)

**FAQ:**

- `GET /api/faq` - FAQ 목록
- `POST /api/faq` - 작성 (관리자)
- `PUT /api/faq/reorder` - 순서 변경 (관리자)

**1:1 문의:**

- `POST /api/inquiries` - 문의 작성
- `GET /api/inquiries` - 내 문의 목록
- `GET /api/inquiries/guest` - 비회원 조회
- `POST /api/inquiries/{id}/answer` - 답변 (관리자)

### Database Schema

- `returns` - 반품 정보
- `return_items` - 반품 아이템
- `return_images` - 반품 사진
- `exchanges` - 교환 정보
- `exchange_items` - 교환 아이템
- `product_questions` - 상품 Q&A
- `notices` - 공지사항
- `faqs` - FAQ
- `inquiries` - 1:1 문의
- `inquiry_attachments` - 문의 첨부 파일

### Frontend Integration Ready (Week 18+)

- 반품/교환 신청 페이지
- 반품/교환 내역 페이지
- 상품 Q&A 페이지
- 공지사항 페이지
- FAQ 페이지
- 1:1 문의 페이지

### Next Steps (Week 22-25)

- 리뷰 시스템
- 소셜 로그인 (네이버, 카카오)
- SMS 인증
- 이메일 발송 (실제 연동)
- 결제 PG 연동
- 배송 추적 API 연동
- 성능 최적화
- 보안 강화

---

**Note**: 모든 알림 발송은 현재 예약만 하며, Week 22-25에 실제 발송 기능을 구현합니다.
