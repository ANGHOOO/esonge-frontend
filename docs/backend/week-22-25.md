# Week 22-25: 리뷰 시스템 및 외부 API 연동

**기간**: Week 22-25
**목표**: 리뷰 시스템 구현 + 모든 외부 API 연동 (소셜 로그인, SMS, 이메일, 결제, 배송)
**프론트엔드 연동**: Week 22부터 시작

---

## 📋 Issue Tickets (로컬 개발)

### [BE-045] 리뷰 시스템 구현

**Priority**: 🔴 Critical
**Estimated Time**: 12 hours

#### Description

구매 확정된 상품에 대해 리뷰를 작성하고 평가할 수 있는 시스템을 구현합니다.

#### Functional Requirements

**Review Entity 설계:**

- id (Primary Key, Auto Increment)
- product_id (FK to products, not null)
- user_id (FK to users, not null)
- order_item_id (FK to order_items, not null)
- rating (평점, 1~5, not null)
- title (제목, 50자 제한)
- content (내용, Text, 10~1000자)
- is_verified_purchase (구매 인증 여부, Boolean, default true)
- helpful_count (도움 됨 개수, default 0)
- unhelpful_count (도움 안 됨 개수, default 0)
- admin_reply (관리자 답글, Text, nullable)
- replied_at (답글 작성 시간)
- created_at, updated_at

**ReviewImage Entity 설계:**

- id (Primary Key, Auto Increment)
- review_id (FK to reviews, not null)
- image_url (이미지 URL, AWS S3)
- display_order (표시 순서)
- created_at

**ReviewVote Entity 설계:**

- id (Primary Key, Auto Increment)
- review_id (FK to reviews, not null)
- user_id (FK to users, not null)
- vote_type (Enum: HELPFUL, UNHELPFUL)
- created_at
- Unique constraint: (review_id, user_id)

**비즈니스 로직:**

1. **리뷰 작성 가능 조건**
   - 주문 상태: DELIVERED (배송 완료) 또는 자동 구매 확정된 주문
   - 해당 상품에 대해 아직 리뷰 작성 안 함 (1주문 1상품 1리뷰)
   - 배송 완료 후 90일 이내

2. **리뷰 작성 프로세스**

   **Step 1: 작성 가능 상품 조회**
   - 사용자의 배송 완료/구매 확정 주문 조회
   - 아직 리뷰 작성 안 한 상품만 필터링
   - 리뷰 작성 마감일 표시 (배송 완료 후 90일)

   **Step 2: 리뷰 작성**
   - 평점 선택 (1~5점, 필수)
   - 제목 입력 (선택, 최대 50자)
   - 내용 입력 (필수, 10~1000자)
   - 사진 업로드 (선택, 최대 5장)
   - is_verified_purchase → true (실제 구매한 상품이므로)

   **Step 3: 리뷰 저장**
   - Review 레코드 생성
   - ReviewImage 레코드 생성 (사진 있는 경우)
   - 상품의 평균 평점 재계산 및 업데이트
     - Product.rating_average = 모든 리뷰 평균
     - Product.review_count += 1
   - 리뷰 작성 적립금 지급 (500~1000원, 사진 있으면 추가)
     - 텍스트만: 500 마일리지
     - 텍스트 + 사진: 1000 마일리지
   - MileageTransaction 생성 (type: EARN_REVIEW)

3. **리뷰 목록 조회**

   **상품별 리뷰:**
   - 해당 상품의 모든 리뷰
   - 기본 정렬: 최신순
   - 정렬 옵션:
     - 최신순 (created_at desc)
     - 평점 높은순 (rating desc)
     - 평점 낮은순 (rating asc)
     - 도움 됨 많은순 (helpful_count desc)
   - 평점별 필터링 (5점만, 4점 이상, 3점 이하 등)
   - 포토 리뷰만 보기 (ReviewImage 있는 것만)
   - 페이지네이션

   **내 리뷰:**
   - 사용자가 작성한 모든 리뷰
   - 상품 정보 함께 표시

4. **리뷰 상세 조회**
   - 리뷰 정보 (평점, 제목, 내용, 사진)
   - 작성자 정보 (이름 마스킹: 홍\*동)
   - 구매 인증 여부
   - 도움 됨/안 됨 개수
   - 관리자 답글 (있는 경우)
   - 해당 상품 정보

5. **리뷰 도움 평가**
   - 로그인한 사용자만 가능
   - 본인 리뷰는 평가 불가
   - 1인 1리뷰 1평가 (HELPFUL 또는 UNHELPFUL 중 하나만)
   - 평가 변경 가능
   - 평가 시 Review.helpful_count 또는 unhelpful_count 증가
   - 평가 취소 시 감소

6. **리뷰 수정/삭제**
   - 본인이 작성한 리뷰만 가능
   - 작성 후 90일 이내만 수정/삭제 가능
   - 수정 시 적립금 회수하지 않음
   - 삭제 시 적립금 회수 (MileageTransaction 생성, type: REFUND)

7. **관리자 답글**
   - 관리자만 작성 가능
   - 리뷰당 1개의 답글만 가능
   - 답글 수정 가능
   - 답글 삭제 가능

8. **상품 평점 통계**
   - 평균 평점
   - 총 리뷰 개수
   - 평점별 분포 (5점 N개, 4점 N개, ...)
   - 포토 리뷰 개수

**API Endpoints:**

- `GET /api/users/reviewable-products` - 리뷰 작성 가능한 상품 목록
  - Query params: page, size
  - Response:
    - products (배열)
      - orderItemId
      - productInfo
      - deliveredAt
      - reviewDeadline (90일 후)

- `POST /api/reviews` - 리뷰 작성
  - Request body:
    - orderItemId
    - rating (1~5)
    - title (선택)
    - content
    - images (이미지 URL 배열, 선택)
  - Response:
    - review (생성된 리뷰 정보)
    - mileageEarned (적립된 마일리지)

- `GET /api/products/{productId}/reviews` - 상품 리뷰 목록
  - Query params:
    - page, size
    - sort (latest, rating_high, rating_low, helpful)
    - rating (평점 필터: 5, 4, 3, 2, 1)
    - photoOnly (포토 리뷰만: true/false)
  - Response:
    - reviews (리뷰 목록)
    - statistics (평점 통계)

- `GET /api/reviews/{reviewId}` - 리뷰 상세
  - Response:
    - review (리뷰 정보)
    - images (사진 목록)
    - product (상품 정보)
    - adminReply (관리자 답글, 있으면)
    - myVote (내가 한 평가, 로그인 시)

- `PUT /api/reviews/{reviewId}` - 리뷰 수정
  - 본인 확인, 90일 이내만
  - Request body: rating, title, content, images
  - Response: 수정된 리뷰

- `DELETE /api/reviews/{reviewId}` - 리뷰 삭제
  - 본인 확인, 90일 이내만
  - 적립금 회수 처리
  - Response: 성공 메시지

- `GET /api/users/reviews` - 내 리뷰 목록
  - Query params: page, size
  - Response: 내가 작성한 리뷰 목록

- `POST /api/reviews/{reviewId}/vote` - 리뷰 도움 평가
  - Request body: voteType (HELPFUL / UNHELPFUL)
  - Response:
    - helpfulCount
    - unhelpfulCount
    - myVote

- `DELETE /api/reviews/{reviewId}/vote` - 평가 취소
  - Response: 취소 결과

- `POST /api/reviews/{reviewId}/reply` - 관리자 답글 (관리자)
  - Request body: replyContent
  - Response: 답글 정보

- `PUT /api/reviews/{reviewId}/reply` - 관리자 답글 수정 (관리자)
  - Request body: replyContent
  - Response: 수정된 답글

- `DELETE /api/reviews/{reviewId}/reply` - 관리자 답글 삭제 (관리자)
  - Response: 성공 메시지

- `GET /api/products/{productId}/review-stats` - 리뷰 통계
  - Response:
    - averageRating (평균 평점)
    - totalReviews (총 리뷰 수)
    - ratingDistribution (평점별 개수: { "5": 10, "4": 5, ... })
    - photoReviewCount (포토 리뷰 개수)

**Error Handling:**

- 이미 리뷰 작성: `REVIEW_ALREADY_EXISTS`
- 리뷰 작성 기간 만료: `REVIEW_PERIOD_EXPIRED`
- 구매하지 않은 상품: `NOT_PURCHASED_PRODUCT`
- 본인 리뷰 평가: `CANNOT_VOTE_OWN_REVIEW`

#### Acceptance Criteria

- 구매 확정된 상품에만 리뷰 작성 가능
- 리뷰 작성 시 적립금 지급
- 리뷰 삭제 시 적립금 회수
- 평균 평점 자동 계산
- 도움 평가 중복 방지

---

## 📋 Issue Tickets (외부 API 연동)

### [BE-046] 네이버 OAuth 2.0 소셜 로그인 연동

**Priority**: 🔴 Critical
**Estimated Time**: 8 hours

#### Description

네이버 계정으로 로그인할 수 있는 기능을 구현합니다. Week 3-4에서 제외했던 소셜 로그인을 이제 구현합니다.

#### Functional Requirements

**연동 준비:**

1. 네이버 개발자 센터 (https://developers.naver.com)에 애플리케이션 등록
2. Client ID 및 Client Secret 발급
3. Callback URL 설정: `{BACKEND_URL}/api/auth/naver/callback`
4. 사용 API: 네이버 로그인
5. 제공 정보 동의 항목: 이메일, 이름, 프로필 이미지

**OAuth 2.0 Flow:**

1. **로그인 요청 (프론트엔드 → 네이버)**
   - 프론트엔드에서 네이버 로그인 버튼 클릭
   - 네이버 OAuth 인증 URL로 리다이렉트
   - URL: `https://nid.naver.com/oauth2.0/authorize`
   - 파라미터:
     - response_type=code
     - client_id={CLIENT_ID}
     - redirect_uri={CALLBACK_URL}
     - state={RANDOM_STRING} (CSRF 방지)

2. **Authorization Code 받기 (네이버 → 백엔드)**
   - 사용자가 네이버 로그인 후 동의
   - 네이버가 Callback URL로 리다이렉트
   - 쿼리 파라미터로 code, state 전달

3. **Access Token 발급 (백엔드 → 네이버)**
   - Callback에서 code, state 받기
   - state 검증 (CSRF 확인)
   - 네이버 토큰 발급 API 호출
   - URL: `https://nid.naver.com/oauth2.0/token`
   - 파라미터:
     - grant_type=authorization_code
     - client_id, client_secret
     - code, state
   - 응답: access_token, refresh_token, expires_in

4. **사용자 정보 조회 (백엔드 → 네이버)**
   - 네이버 회원 정보 API 호출
   - URL: `https://openapi.naver.com/v1/nid/me`
   - Header: `Authorization: Bearer {access_token}`
   - 응답:
     - id (네이버 고유 ID)
     - email
     - name
     - profile_image

5. **회원가입 또는 로그인 처리**

   **신규 사용자:**
   - User 테이블에서 email로 조회
   - 없으면 신규 회원가입
   - User 생성:
     - email (네이버 이메일)
     - name (네이버 이름)
     - password_hash (랜덤 값, 사용 안 함)
     - profile_image_url (네이버 프로필 이미지)
     - oauth_provider = "NAVER"
     - oauth_id (네이버 고유 ID 저장)
   - 회원가입 적립금 지급 (3,000 마일리지)

   **기존 사용자:**
   - email로 User 조회
   - oauth_provider가 없으면 업데이트 (일반 회원 → 네이버 연동)
   - oauth_id 업데이트

6. **JWT 토큰 발급 및 리다이렉트**
   - Access Token, Refresh Token 생성
   - RefreshToken 테이블에 저장
   - 프론트엔드 Callback URL로 리다이렉트
   - URL: `{FRONTEND_URL}/auth/callback?accessToken={JWT_ACCESS}&refreshToken={JWT_REFRESH}`
   - 프론트엔드에서 토큰 저장 및 로그인 처리

**Entity 수정:**

- User 테이블에 필드 추가:
  - oauth_provider (Enum: LOCAL, NAVER, KAKAO, nullable)
  - oauth_id (String, 소셜 고유 ID, nullable)

**API Endpoints:**

- `GET /api/auth/naver` - 네이버 로그인 시작
  - 네이버 OAuth URL로 리다이렉트
  - state 생성 및 세션 저장

- `GET /api/auth/naver/callback` - 네이버 콜백
  - Query params: code, state
  - Processing:
    - state 검증
    - Access Token 발급
    - 사용자 정보 조회
    - 회원가입 또는 로그인
    - JWT 발급
  - Redirect: 프론트엔드 callback URL

**Error Handling:**

- state 불일치: `INVALID_STATE`
- 네이버 API 에러: `NAVER_API_ERROR`
- 토큰 발급 실패: `TOKEN_ISSUANCE_FAILED`

#### Acceptance Criteria

- 네이버 로그인 버튼으로 로그인 가능
- 신규 사용자 자동 회원가입
- 기존 사용자(이메일 동일) 로그인
- 프로필 정보 자동 동기화

---

### [BE-047] 카카오 OAuth 2.0 소셜 로그인 연동

**Priority**: 🔴 Critical
**Estimated Time**: 8 hours

#### Description

카카오 계정으로 로그인할 수 있는 기능을 구현합니다.

#### Functional Requirements

**연동 준비:**

1. 카카오 개발자 센터 (https://developers.kakao.com)에 애플리케이션 등록
2. REST API 키 발급
3. Redirect URI 설정: `{BACKEND_URL}/api/auth/kakao/callback`
4. 카카오 로그인 활성화
5. 동의 항목 설정: 이메일, 닉네임, 프로필 이미지

**OAuth 2.0 Flow:**
(네이버와 거의 동일하지만 카카오 API 사용)

1. **로그인 요청**
   - URL: `https://kauth.kakao.com/oauth/authorize`
   - 파라미터:
     - response_type=code
     - client_id={REST_API_KEY}
     - redirect_uri={CALLBACK_URL}

2. **Authorization Code 받기**
   - 카카오가 Callback URL로 리다이렉트
   - code 전달

3. **Access Token 발급**
   - URL: `https://kauth.kakao.com/oauth/token`
   - Content-Type: application/x-www-form-urlencoded
   - 파라미터:
     - grant_type=authorization_code
     - client_id={REST_API_KEY}
     - redirect_uri={CALLBACK_URL}
     - code

4. **사용자 정보 조회**
   - URL: `https://kapi.kakao.com/v2/user/me`
   - Header: `Authorization: Bearer {access_token}`
   - 응답:
     - id (카카오 고유 ID)
     - kakao_account.email
     - kakao_account.profile.nickname
     - kakao_account.profile.profile_image_url

5. **회원가입 또는 로그인**
   - 네이버와 동일한 로직
   - oauth_provider = "KAKAO"
   - oauth_id = 카카오 고유 ID

6. **JWT 발급 및 리다이렉트**
   - 네이버와 동일

**API Endpoints:**

- `GET /api/auth/kakao` - 카카오 로그인 시작
- `GET /api/auth/kakao/callback` - 카카오 콜백

**Error Handling:**

- 카카오 API 에러: `KAKAO_API_ERROR`
- 이메일 미제공: `EMAIL_NOT_PROVIDED` (카카오는 이메일 선택 동의)

#### Acceptance Criteria

- 카카오 로그인 버튼으로 로그인 가능
- 신규 사용자 자동 회원가입
- 이메일 동의 필수 처리

---

### [BE-048] SMS 인증 연동

**Priority**: 🔴 Critical
**Estimated Time**: 10 hours

#### Description

휴대폰 번호 인증을 위한 SMS 발송 기능을 구현합니다. Week 3-4에서 제외했던 SMS 인증을 이제 구현합니다.

#### Functional Requirements

**SMS 서비스 선택:**

- 국내 SMS 발송 서비스 사용 (예: NHN Cloud SMS, 알리고, 네이버 클라우드 SMS 등)
- 또는 Twilio (해외, 한국 번호 지원)

**연동 준비:**

1. SMS 서비스 가입 및 API 키 발급
2. 발신 번호 등록 (사전 승인 필요)
3. 템플릿 등록 (스팸 방지)

**비즈니스 로직:**

1. **인증번호 발송**

   **Step 1: 전화번호 검증**
   - 한국 휴대폰 번호 형식 검증 (010-XXXX-XXXX)
   - 중복 가입 확인 (회원가입 시)

   **Step 2: 인증번호 생성**
   - 6자리 랜덤 숫자 생성
   - PhoneVerificationCode 테이블에 저장
     - phone
     - code (해싱 저장 권장)
     - expires_at (5분 후)
     - verified (false)
   - 동일 번호로 5분 내 재발송 제한

   **Step 3: SMS 발송**
   - SMS API 호출
   - 템플릿: "[Esonge] 인증번호는 [{code}]입니다."
   - 발송 실패 시 에러 처리
   - 발송 성공 시 발송 이력 저장 (선택)

2. **인증번호 확인**

   **Step 1: 입력값 검증**
   - 전화번호 + 인증번호 조회
   - 만료 시간 확인 (5분 이내)
   - 이미 인증된 코드인지 확인

   **Step 2: 인증 처리**
   - 코드 일치 확인
   - verified → true
   - 회원가입 플로우면 phone_verified → true
   - 전화번호 변경 플로우면 User.phone 업데이트

3. **Rate Limiting**
   - 동일 번호로 1분에 1회만 발송 가능
   - 동일 IP에서 시간당 10회 제한
   - 하루 동일 번호 최대 5회 제한

4. **보안**
   - 인증번호 브루트포스 방지 (5회 실패 시 5분 차단)
   - 인증번호 해싱 저장
   - 만료된 코드 정기 삭제 (스케줄러)

**API Endpoints:**

- `POST /api/auth/send-sms` - SMS 인증번호 발송
  - Request body:
    - phone (휴대폰 번호)
    - purpose (회원가입, 비밀번호 찾기, 전화번호 변경 등)
  - Response:
    - message: "인증번호가 발송되었습니다"
    - expiresAt: "2024-12-01T15:35:00"

- `POST /api/auth/verify-sms` - SMS 인증번호 확인
  - Request body:
    - phone
    - code (6자리 숫자)
  - Response:
    - verified: true
    - message: "인증되었습니다"

**Error Handling:**

- 잘못된 번호 형식: `INVALID_PHONE_FORMAT`
- 발송 제한 초과: `SMS_RATE_LIMIT_EXCEEDED`
- 인증번호 불일치: `VERIFICATION_CODE_MISMATCH`
- 인증번호 만료: `VERIFICATION_CODE_EXPIRED`
- 시도 횟수 초과: `TOO_MANY_ATTEMPTS`

#### Acceptance Criteria

- SMS 정상 발송
- 인증번호 5분 유효
- Rate limiting 정상 작동
- 인증 성공 시 전화번호 검증 완료

---

### [BE-049] 이메일 발송 시스템 연동 (AWS SES)

**Priority**: 🔴 Critical
**Estimated Time**: 10 hours

#### Description

각종 알림 이메일을 실제로 발송하는 기능을 구현합니다. 지금까지 예약만 했던 이메일들을 실제로 발송합니다.

#### Functional Requirements

**AWS SES 설정:**

1. AWS SES 활성화 (리전: ap-northeast-2)
2. 발신 이메일 주소 검증 (noreply@esonge.co.kr)
3. Production 액세스 신청 (Sandbox 벗어나기)
4. SMTP 자격 증명 생성 또는 AWS SDK 사용

**이메일 템플릿:**

1. **회원가입 환영 이메일**
   - 제목: "[Esonge] 회원가입을 환영합니다"
   - 내용:
     - 환영 메시지
     - 회원 혜택 안내
     - 첫 구매 쿠폰 (선택)

2. **비밀번호 재설정 이메일**
   - 제목: "[Esonge] 비밀번호 재설정 안내"
   - 내용:
     - 비밀번호 재설정 링크 (유효기간 1시간)
     - 주의사항

3. **주문 확인 이메일**
   - 제목: "[Esonge] 주문이 완료되었습니다 (주문번호: {ORDER_NUMBER})"
   - 내용:
     - 주문 상품 목록
     - 배송지 정보
     - 결제 금액
     - 적립 마일리지
     - 주문 상세 링크

4. **배송 시작 이메일**
   - 제목: "[Esonge] 상품이 발송되었습니다"
   - 내용:
     - 송장번호
     - 택배사
     - 배송 조회 링크

5. **배송 완료 이메일**
   - 제목: "[Esonge] 상품이 배송 완료되었습니다"
   - 내용:
     - 구매 확정 안내 (7일 후 자동)
     - 리뷰 작성 요청
     - 리뷰 작성 시 적립금 안내

6. **리뷰 답글 알림**
   - 제목: "[Esonge] 작성하신 리뷰에 답글이 달렸습니다"
   - 내용:
     - 리뷰 내용
     - 관리자 답글
     - 리뷰 페이지 링크

7. **문의 답변 이메일**
   - 제목: "[Esonge] 문의하신 내용에 답변이 등록되었습니다"
   - 내용:
     - 문의 내용
     - 답변 내용
     - 문의 상세 링크

8. **반품/교환 상태 알림**
   - 제목: "[Esonge] 반품/교환 상태가 변경되었습니다"
   - 내용:
     - 현재 상태
     - 다음 단계 안내

**비즈니스 로직:**

1. **이메일 전송 서비스 구현**

   **EmailService 인터페이스:**
   - sendEmail(to, subject, content)
   - sendTemplateEmail(to, template, variables)
   - sendBulkEmail(recipients, subject, content)

   **AWS SES 구현체:**
   - AWS SDK for Java 사용
   - SesClient 설정
   - SendEmailRequest 생성
   - HTML 이메일 지원

2. **이메일 템플릿 엔진**
   - Thymeleaf 또는 FreeMarker 사용
   - 템플릿 파일: src/main/resources/email-templates/
   - 변수 치환 (주문번호, 사용자명 등)

3. **비동기 발송**
   - @Async 어노테이션 사용
   - 별도 스레드 풀에서 발송
   - 실패 시 재시도 로직 (최대 3회)
   - 발송 이력 저장 (EmailLog 테이블)

4. **EmailLog Entity:**
   - id
   - recipient_email
   - subject
   - template_name
   - status (PENDING, SENT, FAILED)
   - error_message (실패 사유)
   - sent_at
   - created_at

5. **기존 "예약" 코드 수정**
   - 지금까지 주석 처리했던 이메일 발송 코드 활성화
   - 각 이벤트에서 실제 이메일 발송 호출
   - 예:
     - 회원가입 완료 → sendWelcomeEmail()
     - 주문 완료 → sendOrderConfirmationEmail()
     - 배송 시작 → sendShipmentEmail()

**API Endpoints:**

- `POST /api/admin/email/test` - 테스트 이메일 발송 (관리자)
  - Request body:
    - to
    - template
    - variables
  - Response: 발송 결과

**Error Handling:**

- SES 발송 실패: `EMAIL_SEND_FAILED`
- 잘못된 이메일 주소: `INVALID_EMAIL_ADDRESS`
- SES 할당량 초과: `SES_QUOTA_EXCEEDED`

#### Acceptance Criteria

- 모든 이메일 템플릿 정상 발송
- HTML 이메일 정상 렌더링
- 비동기 발송으로 성능 영향 없음
- 발송 실패 시 로그 기록

---

### [BE-050] 결제 PG 연동

**Priority**: 🔴 Critical
**Estimated Time**: 16 hours

#### Description

Week 13-17에서 스텁으로 처리했던 결제를 실제 PG사 API로 연동합니다.

#### Functional Requirements

**PG사 선택:**

- 토스페이먼츠 (Toss Payments)
- 또는 이니시스, KG이니시스, 나이스페이 등

**토스페이먼츠 연동 (예시):**

1. **연동 준비**
   - 토스페이먼츠 가맹점 신청
   - Client Key, Secret Key 발급
   - 테스트 환경 / 운영 환경 분리

2. **결제 Flow:**

   **Step 1: 결제 요청 (프론트엔드)**
   - 주문 생성 (기존 로직)
   - 토스페이먼츠 SDK로 결제창 호출
   - 파라미터:
     - amount (결제 금액)
     - orderId (주문 번호)
     - orderName (주문명: "송이버섯 외 2건")
     - customerName (주문자명)
     - successUrl (성공 시 리다이렉트 URL)
     - failUrl (실패 시 리다이렉트 URL)

   **Step 2: 결제 승인 요청 (백엔드)**
   - 토스가 successUrl로 리다이렉트 (paymentKey, orderId, amount 포함)
   - 백엔드에서 토스 결제 승인 API 호출
   - URL: `https://api.tosspayments.com/v1/payments/confirm`
   - Header: `Authorization: Basic {Base64(secretKey:)}`
   - Body:
     - paymentKey
     - orderId
     - amount
   - 응답:
     - status (DONE, CANCELED 등)
     - method (카드, 계좌이체 등)
     - approvedAt (승인 시간)
     - receipt.url (영수증 URL)

   **Step 3: 결제 완료 처리**
   - Payment 레코드 업데이트
     - payment_status → COMPLETED
     - transaction_id (paymentKey 저장)
     - paid_at
   - Order 상태 업데이트
     - payment_status → COMPLETED
     - order_status → PAYMENT_COMPLETED
   - 적립금 지급
   - 주문 확인 이메일 발송

3. **결제 수단별 처리:**

   **신용카드:**
   - 토스가 카드사와 통신
   - 즉시 승인 또는 거절

   **계좌이체:**
   - 실시간 계좌이체
   - 은행 인증 후 즉시 이체

   **가상계좌:**
   - 가상계좌 발급
   - 고객이 24시간 내 입금
   - 웹훅으로 입금 알림 받기
   - 입금 확인 후 주문 처리

   **카카오페이, 네이버페이:**
   - 간편결제
   - 토스 SDK에서 지원

4. **결제 취소/환불:**

   **전액 취소:**
   - 토스 결제 취소 API 호출
   - URL: `https://api.tosspayments.com/v1/payments/{paymentKey}/cancel`
   - Body:
     - cancelReason (취소 사유)
   - 응답:
     - cancels (취소 내역 배열)

   **부분 취소:**
   - cancelAmount (취소 금액) 파라미터 추가
   - 부분 취소 가능 (반품 시)

5. **웹훅 처리:**
   - 가상계좌 입금 알림
   - URL: `{BACKEND_URL}/api/payments/webhook`
   - 토스에서 POST 요청
   - Body:
     - eventType (PAYMENT.VIRTUAL_ACCOUNT.DEPOSITED)
     - data (결제 정보)
   - 검증:
     - signature 확인 (보안)
   - 처리:
     - Payment 업데이트
     - Order 상태 변경
     - 주문 확인 이메일 발송

**Entity 수정:**

- Payment 테이블에 필드 추가:
  - payment_key (토스 paymentKey)
  - receipt_url (영수증 URL)
  - pg_response (JSON, 전체 응답 저장)

**API Endpoints:**

- `POST /api/payments/confirm` - 결제 승인 (토스 리다이렉트 후 호출)
  - Request body:
    - paymentKey
    - orderId
    - amount
  - Response:
    - payment (결제 정보)
    - order (주문 정보)
    - receiptUrl

- `POST /api/payments/{paymentId}/cancel` - 결제 취소
  - Request body:
    - cancelReason
    - cancelAmount (부분 취소 시)
  - Response: 취소 정보

- `POST /api/payments/webhook` - 토스 웹훅
  - Header: Toss-Signature (검증용)
  - Body: 토스가 보내는 데이터
  - Response: 200 OK

**Error Handling:**

- 결제 승인 실패: `PAYMENT_APPROVAL_FAILED`
- 금액 불일치: `AMOUNT_MISMATCH`
- 결제 취소 실패: `PAYMENT_CANCEL_FAILED`
- 웹훅 서명 불일치: `INVALID_WEBHOOK_SIGNATURE`

#### Acceptance Criteria

- 카드 결제 정상 작동
- 가상계좌 발급 및 입금 확인
- 결제 취소 및 부분 환불 작동
- 웹훅 정상 처리
- 기존 스텁 코드 완전 교체

---

### [BE-051] 배송 추적 API 연동

**Priority**: 🟡 High
**Estimated Time**: 8 hours

#### Description

택배사 API와 연동하여 실시간 배송 조회 기능을 구현합니다.

#### Functional Requirements

**배송 조회 서비스 선택:**

- 스마트택배 API (https://www.smartparcel.com)
- 또는 택배사별 개별 API

**연동 준비:**

1. API 키 발급
2. 지원 택배사 확인 (CJ대한통운, 우체국, 로젠 등)

**비즈니스 로직:**

1. **배송 조회**
   - 입력: 택배사 코드, 송장번호
   - API 호출
   - 응답:
     - 현재 위치
     - 배송 상태
     - 배송 이력 (시간, 위치, 상태)

2. **배송 상태 매핑**
   - API 응답 → 내부 상태 매핑
   - 예:
     - "상품 인수" → PICKED_UP
     - "배송 중" → IN_TRANSIT
     - "배송 완료" → DELIVERED

3. **자동 배송 상태 업데이트**
   - 스케줄러로 배송 중인 주문 조회
   - 배송 조회 API 호출
   - 배송 완료 감지 시 Order.order_status → DELIVERED

**API Endpoints:**

- `GET /api/orders/{orderId}/tracking` - 배송 조회 (스텁 교체)
  - Response:
    - trackingNumber
    - carrier
    - currentStatus
    - estimatedDelivery
    - trackingEvents (배열)
      - time
      - location
      - status
      - description

**Error Handling:**

- 송장번호 없음: `TRACKING_NUMBER_NOT_FOUND`
- 배송 조회 API 에러: `TRACKING_API_ERROR`

#### Acceptance Criteria

- 실시간 배송 정보 조회
- 배송 완료 시 자동 상태 업데이트

---

### [BE-052] 성능 최적화

**Priority**: 🟢 Medium
**Estimated Time**: 12 hours

#### Description

전체 시스템의 성능을 최적화합니다.

#### Functional Requirements

**데이터베이스 최적화:**

1. **쿼리 최적화**
   - N+1 쿼리 문제 해결 (@EntityGraph, Join Fetch)
   - Slow Query 분석 및 개선
   - 인덱스 추가 (자주 검색되는 컬럼)

2. **인덱스 추가 권장:**
   - products: (category_id, is_active, created_at)
   - orders: (user_id, order_status, created_at)
   - reviews: (product_id, created_at)
   - cart_items: (user_id, session_id)

3. **페이지네이션 개선:**
   - Cursor 기반 페이지네이션 고려 (대량 데이터)
   - Count 쿼리 캐싱

**캐싱 전략:**

1. **Redis 캐싱 적용:**
   - 상품 목록 (5분)
   - 카테고리 트리 (1시간)
   - 베스트/신상품 (10분)
   - 사용자 세션 (로그인 상태 유지)

2. **Spring Cache 사용:**
   - @Cacheable, @CacheEvict, @CachePut
   - 캐시 키 전략 설정

**응답 속도 개선:**

1. **비동기 처리:**
   - 이메일 발송 (@Async)
   - 알림 발송 (@Async)
   - 통계 계산 (백그라운드)

2. **API 응답 최적화:**
   - DTO projection (필요한 필드만 조회)
   - Lazy Loading 전략
   - Batch Size 설정

**CDN 및 정적 파일:**

1. **AWS CloudFront 연동:**
   - S3 이미지 캐싱
   - 정적 파일 배포

**모니터링:**

1. **Spring Boot Actuator:**
   - Health check
   - Metrics

2. **APM 도구:**
   - Pinpoint 또는 Scouter
   - 느린 API 추적

#### Acceptance Criteria

- 평균 응답 시간 < 200ms
- 상품 목록 조회 < 100ms
- Redis 캐시 hit rate > 80%

---

### [BE-053] 보안 강화

**Priority**: 🔴 Critical
**Estimated Time**: 10 hours

#### Description

보안 취약점을 보완하고 보안을 강화합니다.

#### Functional Requirements

**보안 체크리스트:**

1. **인증/인가:**
   - JWT 만료 시간 적절히 설정
   - Refresh Token rotation 구현
   - 비밀번호 정책 강화 (최소 8자, 영문+숫자+특수문자)

2. **SQL Injection 방지:**
   - Prepared Statement 사용 확인
   - JPQL 파라미터 바인딩

3. **XSS 방지:**
   - HTML 이스케이프 처리
   - CSP 헤더 설정

4. **CSRF 방지:**
   - Spring Security CSRF 토큰
   - SameSite Cookie 설정

5. **Rate Limiting:**
   - Bucket4j로 API 요청 제한
   - 로그인 시도 제한 (5회 실패 시 10분 차단)

6. **민감 정보 보호:**
   - 로그에 비밀번호/토큰 출력 금지
   - API 응답에서 민감 정보 제외

7. **HTTPS 강제:**
   - 프로덕션 환경 HTTPS only
   - HSTS 헤더 설정

8. **의존성 보안:**
   - 취약한 라이브러리 업데이트
   - OWASP Dependency Check

#### Acceptance Criteria

- OWASP Top 10 취약점 모두 대응
- 보안 테스트 통과
- 민감 정보 노출 없음

---

## 📊 Week 22-25 Summary

### Deliverables (로컬)

- ✅ 리뷰 시스템

### Deliverables (외부 연동)

- ✅ 네이버 소셜 로그인
- ✅ 카카오 소셜 로그인
- ✅ SMS 인증 (회원가입, 비밀번호 찾기)
- ✅ 이메일 발송 (AWS SES)
- ✅ 결제 PG 연동 (토스페이먼츠 등)
- ✅ 배송 추적 API
- ✅ 성능 최적화
- ✅ 보안 강화

### Key Endpoints (Week 22-25)

**리뷰:**

- `GET /api/users/reviewable-products` - 리뷰 작성 가능 상품
- `POST /api/reviews` - 리뷰 작성
- `GET /api/products/{id}/reviews` - 상품 리뷰 목록
- `POST /api/reviews/{id}/vote` - 리뷰 도움 평가
- `POST /api/reviews/{id}/reply` - 관리자 답글

**소셜 로그인:**

- `GET /api/auth/naver` - 네이버 로그인
- `GET /api/auth/naver/callback` - 네이버 콜백
- `GET /api/auth/kakao` - 카카오 로그인
- `GET /api/auth/kakao/callback` - 카카오 콜백

**SMS:**

- `POST /api/auth/send-sms` - SMS 발송
- `POST /api/auth/verify-sms` - SMS 인증

**결제:**

- `POST /api/payments/confirm` - 결제 승인 (PG 연동)
- `POST /api/payments/{id}/cancel` - 결제 취소 (PG 연동)
- `POST /api/payments/webhook` - PG 웹훅

**배송:**

- `GET /api/orders/{id}/tracking` - 실시간 배송 조회

### Database Schema

- `reviews` - 리뷰
- `review_images` - 리뷰 사진
- `review_votes` - 리뷰 도움 평가
- `email_logs` - 이메일 발송 이력

### 외부 서비스 연동 완료

- ✅ 네이버 OAuth 2.0
- ✅ 카카오 OAuth 2.0
- ✅ SMS 발송 서비스
- ✅ AWS SES (이메일)
- ✅ 토스페이먼츠 (결제)
- ✅ 배송 조회 API

### Frontend Integration Ready

- 리뷰 작성/조회 페이지
- 소셜 로그인 버튼
- SMS 인증 플로우
- 실제 결제 프로세스
- 실시간 배송 조회

---

## 🎉 전체 개발 완료

### 최종 시스템 구성

**총 API 개수**: 약 100개 이상

**주요 도메인:**

1. 인증 및 사용자 (15개)
2. 상품 및 카테고리 (10개)
3. 장바구니 (6개)
4. 주문 (12개)
5. 결제 (5개)
6. 배송 (3개)
7. 멤버십 (10개)
8. 쿠폰 (3개)
9. 위시리스트 (4개)
10. 반품/교환 (8개)
11. 리뷰 (8개)
12. 고객 서비스 (15개)

**외부 연동:**

- 소셜 로그인 2개 (네이버, 카카오)
- SMS 1개
- 이메일 1개 (AWS SES)
- 결제 PG 1개
- 배송 조회 1개

**성능 목표 달성:**

- 평균 응답 시간 < 200ms
- 동시 접속 1,000명 처리
- 99.5% 가용성

**보안 준수:**

- OWASP Top 10 대응
- PCI-DSS 준수 (결제 정보 미저장)
- 개인정보 보호법 준수

---

**Note**: 모든 외부 API 연동은 테스트 환경에서 충분히 검증 후 프로덕션 배포를 권장합니다.
